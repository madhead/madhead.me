---
title: 'Fear and loathing of server-side App Store receipts validation'
date: 2020-06-03T09:00:00+03:00
tags:
  - app store
  - pain
---

Some time ago, I wrote a link:../appstore-receipts-validator-j[blogpost] about my https://gitlab.com/madhead/appstore-receipts-validator-j[Java library for App Store receipts validation].
Recently, another developer working on a server-side App Store receipts validation contacted me after reading that article.
We had a pretty long conversation and discussed a lot of nuances.
I never thought that receipt validation could be of some interest, but after that conversation I realized how much pain I have expirienced and how much intricacies are there in this task.

So here it is: everything I wish I knew about server-side App Store receipts validation before I did it for the first time.

<!--more-->

## Contents

* <<disclaimer, Disclaimer>>
* <<intro, Server-side receipts validation>>
* <<docs, Apple documentation>>

[#disclaimer]
## Disclaimer

I am not an expert and I may be wrong.
I may misunderstood some concepts.
Everything I say here is my personal opinion based on my personal expirience.
The information I provide here may be obsolete, always keep in mind the https://developer.apple.com/documentation/storekit/in-app_purchase/validating_receipts_with_the_app_store[official] https://developer.apple.com/documentation/appstorereceipts[documentation].

[#intro]
## Server-side receipts validation

Let's talk about receipts and their validation first.

In this article, by App Store receipt (or just receipt) I mean a piece of information about a purchase made from within the app.
Thus, by employing receipt validation techniques you can authenticate purchased content.

There are https://developer.apple.com/in-app-purchase[four types] of purchaseable content:

 * Consumables
 * Non-consumables
 * Auto-renewable subscriptions
 * Non-renewing subscriptions

There are two receipt validation techniques: on-device and server-side.
A developer should https://developer.apple.com/documentation/storekit/in-app_purchase/choosing_a_receipt_validation_technique[compare both approaches] and determine the best fit his app.
He can also choose to implement both.
In short: server-side validation is more secure and provides more features.

I'll be talking solely about a server-side receipt validation in this article.

From a server-side point of view, a receipt is just a long string, like:

[source]
----
MIIcSAYJKoZIhvcNAQcCoIIcOTCCHDUCAQExCzAJBgUrDgMCGgUAMIIL+QYJKoZIhvcNAQcBoIIL6gS
…≈9622 symbols skipped…
J8rloluUN2JvNwiFzPY0eAtCToLpBfGdL2I3ymDFJWiQbCuuNRa/PfGBFpMc0PGSqyQ0C5GFULTDVU=
----

Let's look at the server-side receipt validation process:

{{< figure src="//storage.googleapis.com/madheadme-static/posts/appstore-receipts-validaton/001.png" class="align-center">}}

So, basically, to validate the purchase on your server, you have to:

 . Pass the receipt from your app to your server
 . Pass the receipt to the Apple for the validation
 . Check the response
 . Make the content available to the user if the purchase was successful

Sounds like a child's play?
Well…

[#docs]
## Apple documentation

### Docs

### What & Why?
### 2 types of recipes, why it's important
HTML instead of JSON
How to detekt new transactions / groups
Incrementing transaction ids (bug?)
How to check expired subscriptions / Useless S2S
https://medium.com/revenuecat-blog/ios-subscriptions-are-hard-d9b29c74e96f
204 S2S
No money in /verifyReceipt
Fastlane / spaceship
