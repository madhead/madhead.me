---
title: 'Fear and loathing of server-side App Store receipts validation'
date: 2020-06-03T09:00:00+03:00
tags:
  - app store
  - pain
---

Some time ago, I wrote a link:../appstore-receipts-validator-j[blogpost] about my https://gitlab.com/madhead/appstore-receipts-validator-j[Java library for App Store receipts validation].
Recently, another developer working on a server-side App Store receipts validation contacted me after reading that article.
We had a pretty long conversation and discussed a lot of nuances.
I never thought that receipt validation could be of some interest, but after that conversation I realized how much pain I have expirienced and how much intricacies there are in this task.

So here it is: everything I wish I knew about server-side App Store receipts validation before I did it for the first time.

<!--more-->

## Contents

* <<disclaimer, Disclaimer>>
* <<intro, Server-side receipts validation>>
* <<docs, Apple documentation>>
* <<sla, SLA>>
* <<tldr, TLDR>>

[#disclaimer]
## Disclaimer

I am not an expert and I may be wrong.
I may misunderstood some concepts.
Everything I say here is my personal opinion based on my personal expirience.
The information I provide here may be obsolete, always keep in mind the https://developer.apple.com/documentation/storekit/in-app_purchase/validating_receipts_with_the_app_store[official] https://developer.apple.com/documentation/appstorereceipts[documentation].
If you have something to add, don't hesistate to leave a comment below!

[#intro]
## Server-side receipts validation

Let's talk about receipts and their validation first.

In this article, by App Store receipt (or just receipt) I mean a piece of information about a purchase made from within the app.
Thus, by employing receipt validation techniques you can authenticate purchased content.

There are https://developer.apple.com/in-app-purchase[four types] of purchaseable content:

 * Consumables
 * Non-consumables
 * Auto-renewable subscriptions
 * Non-renewing subscriptions

There are two receipt validation techniques: on-device and server-side.
A developer should https://developer.apple.com/documentation/storekit/in-app_purchase/choosing_a_receipt_validation_technique[compare both approaches] and determine the best fit his app.
He can also choose to implement both.
In short: server-side validation is more secure and provides more features.

I'll be talking solely about a server-side receipt validation in this article.

From a server-side point of view, a receipt is just a long string, like:

[source]
----
MIIcSAYJKoZIhvcNAQcCoIIcOTCCHDUCAQExCzAJBgUrDgMCGgUAMIIL+QYJKoZIhvcNAQcBoIIL6gS
…≈9622 symbols skipped…
J8rloluUN2JvNwiFzPY0eAtCToLpBfGdL2I3ymDFJWiQbCuuNRa/PfGBFpMc0PGSqyQ0C5GFULTDVU=
----

Let's look at the server-side receipt validation process:

{{< figure src="//storage.googleapis.com/madheadme-static/posts/appstore-receipts-validaton/001.png" class="align-center">}}

So, basically, to validate the purchase on your server, you have to:

 . Pass the receipt from your app to your server
 . Pass the receipt to the Apple for the validation
 . Check the response
 . Make the content available to the user if the purchase was successful

Sounds like a child's play?
Well…

[#docs]
## Apple documentation

Probably the first thing you want to do is to read some documentation.
The best place to start is https://developer.apple.com/documentation/storekit[StoreKit documentation], particularly its section about https://developer.apple.com/documentation/appstorereceipts[App Store Receipts].

However, while you search for the information, like descriptions of receipt fields, you may encounter an old but still available https://developer.apple.com/library/archive/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html#//apple_ref/doc/uid/TP40010573-CH106-SW12[pages] at Apple's documentation archive.
These pages are obsolete and you should not rely on them!
Why doesn't Apple just remove them from the Internet?

**Always check that you're using actual documentation**.

Ok, you're using the most recent documentation.
You expect some formal schema (like https://swagger.io/specification[OpenAPI]) for the response objects to minimize the ambiguity to exist, don't you?

{{< figure src="//storage.googleapis.com/madheadme-static/posts/appstore-receipts-validaton/002.png" class="align-center">}}

Be ready to read vague descriptions, like https://developer.apple.com/documentation/appstorereceipts/responsebody/pending_renewal_info[this]:

> `grace_period_expires_date` string
>
> The time at which the grace period for subscription renewals expires, in a date-time format similar to the ISO 8601.

What do they mean by __similar__?
It's either ISO 8601, or some other format, and we, developers, need to know it in advance to be able to parse it!

https://developer.apple.com/documentation/appstorereceipts/responsebody/latest_receipt_info[Another] example of vagueness:

> `is_in_intro_offer_period` string
>
> An indicator of whether an auto-renewable subscription is in the introductory price period. See https://developer.apple.com/documentation/appstorereceipts/is_in_intro_offer_period[`is_in_intro_offer_period`] for more information.
> 
> Possible values: true, false

So is it a string with values ``"true"`` and ``"false"``, or is it actually a boolean with values `true` and `false`?

All those and similar questions could be resolved with a few sound examples.
Alas, there are no examples at all.

**The existing documentation is vague and lacks of examples**.

[#sla]
## SLA

Ok, you've send some receipts to Apple servers and got some responses.
Let's talk about the https://en.wikipedia.org/wiki/Service-level_agreement[SLA] of that `/verifyReceipt` endpoint.

Long story short: **there is no SLA defined for `/verifyReceipt` endpoint**.

In case of any troubles with the API, you can, probably, check the status at https://developer.apple.com/system-status[developer system status page], but from my expirience it is useless.
Once, I've faced an issue with the production receipt verification endpoint — `\https://buy.itunes.apple.com/verifyReceipt`.
It was returning HTML payloads instead of JSON, something like a default 404 or 500 page.
Obviously, a problem on App Store's side.
I've been observing the issue for about 15 minutes in production and the system status page was all green during that time.
Moreover, I wrote an e-mail to the App Store's technical support team.
They replied about a week (!!!) later, and the reply was useless (not saying it was not actual anymore).

Unluky me?
Unlucky, but not alone.
Here is a https://stackoverflow.com/q/61566293/750510[StackOverflow question] by another poor guy facing a similar issue (probably the same that I did).

You may ask: why the SLA is important?

[#sandbox]
## Sadnbox

https://developer.apple.com/documentation/appstorereceipts/verifyreceipt
Verify your receipt first with the production URL; proceed to verify with the sandbox URL if you receive a 21007 status code. Following this approach ensures that you do not have to switch between URLs while your application is tested, reviewed by App Review, or live in the App Store.

useless sandbox: cannot check certain flows

[#parsing]
## Parsing the receipt

How to detekt new transactions / groups -- they are all in array, how to detekt new?
No money in /verifyReceipt
Fastlane / spaceship

[#s2s]
## S2S

S2S 200 / 204
Useless S2S for checking expired subscriptions 
2 types of recipes, why it's important

[#quirks]
## Quirks / Bugs

Incrementing transaction ids (bug?)

[#tldr]
## TLDR

 . Always check that you're using actual documentation.
 . The existing documentation is vague and lacks of examples.
 . No SLA is defined for `/verifyReceipt` endpoint.

https://medium.com/revenuecat-blog/ios-subscriptions-are-hard-d9b29c74e96f
